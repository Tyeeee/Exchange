package com.hynet.heebit.components.widget.spinner;import android.animation.ObjectAnimator;import android.content.Context;import android.content.res.Resources;import android.content.res.TypedArray;import android.graphics.Color;import android.graphics.drawable.Drawable;import android.os.Build;import android.os.Bundle;import android.os.Parcelable;import android.util.AttributeSet;import android.util.TypedValue;import android.view.Gravity;import android.view.MotionEvent;import android.view.View;import android.widget.AdapterView;import android.widget.ListAdapter;import android.widget.ListView;import android.widget.PopupWindow;import com.hynet.heebit.components.R;import com.hynet.heebit.components.widget.spinner.adapter.BaseAdapter;import com.hynet.heebit.components.widget.spinner.adapter.TextViewSpinnerAdapter;import com.hynet.heebit.components.widget.spinner.adapter.TextViewSpinnerAdapterWrapper;import com.hynet.heebit.components.widget.spinner.listener.OnTextFormatListener;import com.hynet.heebit.components.widget.spinner.listener.implement.DefaultSpinnerTextFormat;import java.util.List;import androidx.annotation.ColorRes;import androidx.annotation.DrawableRes;import androidx.appcompat.widget.AppCompatTextView;import androidx.core.content.ContextCompat;import androidx.core.graphics.drawable.DrawableCompat;import androidx.interpolator.view.animation.LinearOutSlowInInterpolator;public class TextViewSpinner extends AppCompatTextView implements AdapterView.OnItemClickListener, PopupWindow.OnDismissListener {    private static final int MAX_LEVEL = 10000;    private static final int DEFAULT_ELEVATION = 16;    private static final String INSTANCE_STATE = "instance_state";    private static final String SELECTED_INDEX = "selected_index";    private static final String IS_POPUP_SHOWING = "is_popup_showing";    private static final String IS_ARROW_HIDDEN = "is_arrow_hidden";    private static final String ARROW_DRAWABLE_RES_ID = "arrow_drawable_res_id";    public static final int VERTICAL_OFFSET = 1;    private int selectedIndex;    private Drawable arrowDrawable;    private PopupWindow popupWindow;    private ListView listView;    private BaseAdapter baseAdapter;    private AdapterView.OnItemClickListener onItemClickListener;    private AdapterView.OnItemSelectedListener onItemSelectedListener;    private boolean isArrowHidden;    private int textColor;    private int backgroundSelector;    private int arrowDrawableTint;    private int displayHeight;    private int parentVerticalOffset;    private int dropDownListPaddingBottom;    private @DrawableRes    int arrowDrawableResId;    private OnTextFormatListener spinnerTextFormatter = new DefaultSpinnerTextFormat();    private OnTextFormatListener selectedTextFormatter = new DefaultSpinnerTextFormat();    public TextViewSpinner(Context context) {        super(context);        initialize(context, null);    }    public TextViewSpinner(Context context, AttributeSet attrs) {        super(context, attrs);        initialize(context, attrs);    }    public TextViewSpinner(Context context, AttributeSet attrs, int defStyleAttr) {        super(context, attrs, defStyleAttr);        initialize(context, attrs);    }    @Override    public Parcelable onSaveInstanceState() {        Bundle bundle = new Bundle();        bundle.putParcelable(INSTANCE_STATE, super.onSaveInstanceState());        bundle.putInt(SELECTED_INDEX, selectedIndex);        bundle.putBoolean(IS_ARROW_HIDDEN, isArrowHidden);        bundle.putInt(ARROW_DRAWABLE_RES_ID, arrowDrawableResId);        if (popupWindow != null) {            bundle.putBoolean(IS_POPUP_SHOWING, popupWindow.isShowing());        }        return bundle;    }    @Override    public void onRestoreInstanceState(Parcelable savedState) {        if (savedState instanceof Bundle) {            Bundle bundle = (Bundle) savedState;            selectedIndex = bundle.getInt(SELECTED_INDEX);            if (baseAdapter != null) {                setTextInternal(baseAdapter.getItemInDataset(selectedIndex).toString());                baseAdapter.setSelectedIndex(selectedIndex);            }            if (bundle.getBoolean(IS_POPUP_SHOWING)) {                if (popupWindow != null) {                    // Post the show request into the looper to avoid bad token exception                    post(new Runnable() {                        @Override                        public void run() {                            showDropDown();                        }                    });                }            }            isArrowHidden = bundle.getBoolean(IS_ARROW_HIDDEN, false);            arrowDrawableResId = bundle.getInt(ARROW_DRAWABLE_RES_ID);            savedState = bundle.getParcelable(INSTANCE_STATE);        }        super.onRestoreInstanceState(savedState);    }    private void initialize(Context context, AttributeSet attrs) {        Resources resources = getResources();        TypedArray typedArray = context.obtainStyledAttributes(attrs, R.styleable.TextViewSpinner);        int defaultPadding = resources.getDimensionPixelSize(R.dimen.dp_15);        setGravity(Gravity.CENTER_VERTICAL | Gravity.START);        setPadding(resources.getDimensionPixelSize(R.dimen.dp_15), defaultPadding, defaultPadding, defaultPadding);        setClickable(true);        this.backgroundSelector = typedArray.getResourceId(R.styleable.TextViewSpinner_tvs_dropDownListPaddingBottom, R.drawable.selector_spinner);        setBackgroundResource(backgroundSelector);        this.textColor = typedArray.getColor(R.styleable.TextViewSpinner_tvs_textTint, getDefaultTextColor(context));        setTextColor(textColor);        this.listView = new ListView(context);        listView.setId(getId());        listView.setDivider(null);        listView.setItemsCanFocus(true);        listView.setVerticalScrollBarEnabled(false);        listView.setHorizontalScrollBarEnabled(false);        listView.setOnItemClickListener(this);        this.popupWindow = new PopupWindow(context);        popupWindow.setContentView(listView);        popupWindow.setOutsideTouchable(true);        popupWindow.setFocusable(true);        popupWindow.setOnDismissListener(this);        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.LOLLIPOP) {            popupWindow.setElevation(DEFAULT_ELEVATION);            popupWindow.setBackgroundDrawable(ContextCompat.getDrawable(context, R.drawable.shape_spinner));        } else {            popupWindow.setBackgroundDrawable(ContextCompat.getDrawable(context, R.drawable.shape_spinner));        }        this.isArrowHidden = typedArray.getBoolean(R.styleable.TextViewSpinner_tvs_hideArrow, false);        this.arrowDrawableTint = typedArray.getColor(R.styleable.TextViewSpinner_tvs_arrowTint, Integer.MAX_VALUE);        this.arrowDrawableResId = typedArray.getResourceId(R.styleable.TextViewSpinner_tvs_arrowDrawable, R.drawable.shape_spinner_arrow);        this.dropDownListPaddingBottom = typedArray.getDimensionPixelSize(R.styleable.TextViewSpinner_tvs_dropDownListPaddingBottom, 0);        typedArray.recycle();        displayHeight = getContext().getResources().getDisplayMetrics().heightPixels;    }    private int getParentVerticalOffset() {        if (parentVerticalOffset > 0) {            return parentVerticalOffset;        }        int[] locationOnScreen = new int[2];        getLocationOnScreen(locationOnScreen);        return parentVerticalOffset = locationOnScreen[VERTICAL_OFFSET];    }    @Override    protected void onVisibilityChanged(View changedView, int visibility) {        super.onVisibilityChanged(changedView, visibility);        arrowDrawable = initArrowDrawable(arrowDrawableTint);        setArrowDrawableOrHide(arrowDrawable);    }    private Drawable initArrowDrawable(int drawableTint) {        Drawable drawable = ContextCompat.getDrawable(getContext(), arrowDrawableResId);        if (drawable != null) {            drawable = DrawableCompat.wrap(drawable);            if (drawableTint != Integer.MAX_VALUE && drawableTint != 0) {                DrawableCompat.setTint(drawable, drawableTint);            }        }        return drawable;    }    private void setArrowDrawableOrHide(Drawable drawable) {        if (!isArrowHidden && drawable != null) {            setCompoundDrawablesWithIntrinsicBounds(null, null, drawable, null);        } else {            setCompoundDrawablesWithIntrinsicBounds(null, null, null, null);        }    }    private int getDefaultTextColor(Context context) {        TypedValue typedValue = new TypedValue();        context.getTheme().resolveAttribute(android.R.attr.textColorPrimary, typedValue, true);        TypedArray typedArray = context.obtainStyledAttributes(typedValue.data, new int[]{android.R.attr.textColorPrimary});        int defaultTextColor = typedArray.getColor(0, Color.BLACK);        typedArray.recycle();        return defaultTextColor;    }    public int getSelectedIndex() {        return selectedIndex;    }    public void setArrowDrawable(@DrawableRes @ColorRes int drawableId) {        arrowDrawableResId = drawableId;        arrowDrawable = initArrowDrawable(R.drawable.shape_spinner_arrow);        setArrowDrawableOrHide(arrowDrawable);    }    public void setArrowDrawable(Drawable drawable) {        arrowDrawable = drawable;        setArrowDrawableOrHide(arrowDrawable);    }    public void setTextInternal(String text) {        if (selectedTextFormatter != null) {            setText(selectedTextFormatter.onTextFormat(text));        } else {            setText(text);        }    }    public void setSelectedIndex(int position) {        if (baseAdapter != null) {            if (position >= 0 && position <= baseAdapter.getCount()) {                baseAdapter.setSelectedIndex(position);                selectedIndex = position;                setTextInternal(baseAdapter.getItemInDataset(position).toString());            } else {                throw new IllegalArgumentException("Position must be lower than baseAdapter count!");            }        }    }    public void addOnItemClickListener(AdapterView.OnItemClickListener onItemClickListener) {        this.onItemClickListener = onItemClickListener;    }    public void setOnItemSelectedListener(AdapterView.OnItemSelectedListener onItemSelectedListener) {        this.onItemSelectedListener = onItemSelectedListener;    }    public <T> void attachDataSource(List<T> list) {        this.baseAdapter = new TextViewSpinnerAdapter<>(getContext(), list, textColor, backgroundSelector, spinnerTextFormatter);        setAdapterInternal(baseAdapter);    }    public void setBaseAdapter(ListAdapter baseAdapter) {        this.baseAdapter = new TextViewSpinnerAdapterWrapper(getContext(), baseAdapter, textColor, backgroundSelector, spinnerTextFormatter);        setAdapterInternal(this.baseAdapter);    }    private void setAdapterInternal(BaseAdapter baseAdapter) {        selectedIndex = 0;        listView.setAdapter(baseAdapter);        setTextInternal(baseAdapter.getItemInDataset(selectedIndex).toString());    }    @Override    public boolean onTouchEvent(MotionEvent event) {        if (isEnabled() && event.getAction() == MotionEvent.ACTION_UP) {            if (!popupWindow.isShowing()) {                showDropDown();            } else {                dismissDropDown();            }        }        return super.onTouchEvent(event);    }    private void animateArrow(boolean shouldRotateUp) {        int start = shouldRotateUp ? 0 : MAX_LEVEL;        int end = shouldRotateUp ? MAX_LEVEL : 0;        ObjectAnimator animator = ObjectAnimator.ofInt(arrowDrawable, "level", start, end);        animator.setInterpolator(new LinearOutSlowInInterpolator());        animator.start();    }    public void dismissDropDown() {        if (!isArrowHidden) {            animateArrow(false);        }        popupWindow.dismiss();    }    public void showDropDown() {        if (!isArrowHidden) {            animateArrow(true);        }        measurePopUpDimension();        popupWindow.showAsDropDown(this);    }    private void measurePopUpDimension() {        int widthSpec = MeasureSpec.makeMeasureSpec(getMeasuredWidth(), MeasureSpec.EXACTLY);        int heightSpec = MeasureSpec.makeMeasureSpec(displayHeight - getParentVerticalOffset() - getMeasuredHeight(), MeasureSpec.AT_MOST);        listView.measure(widthSpec, heightSpec);        popupWindow.setWidth(listView.getMeasuredWidth());        popupWindow.setHeight(listView.getMeasuredHeight() - dropDownListPaddingBottom);    }    public void setTintColor(@ColorRes int resId) {        if (arrowDrawable != null && !isArrowHidden) {            DrawableCompat.setTint(arrowDrawable, ContextCompat.getColor(getContext(), resId));        }    }    public void setArrowTintColor(int resolvedColor) {        if (arrowDrawable != null && !isArrowHidden) {            DrawableCompat.setTint(arrowDrawable, resolvedColor);        }    }    public void hideArrow() {        isArrowHidden = true;        setArrowDrawableOrHide(arrowDrawable);    }    public void showArrow() {        isArrowHidden = false;        setArrowDrawableOrHide(arrowDrawable);    }    public boolean isArrowHidden() {        return isArrowHidden;    }    public void setDropDownListPaddingBottom(int paddingBottom) {        dropDownListPaddingBottom = paddingBottom;    }    public int getDropDownListPaddingBottom() {        return dropDownListPaddingBottom;    }    public void setSpinnerTextFormatter(OnTextFormatListener onTextFormatListener) {        this.spinnerTextFormatter = onTextFormatListener;    }    public void setSelectedTextFormatter(OnTextFormatListener onTextFormatListener) {        this.selectedTextFormatter = onTextFormatListener;    }    @Override    public void onItemClick(AdapterView<?> parent, View view, int position, long id) {        if (position >= selectedIndex && position < baseAdapter.getCount()) {            position++;        }        selectedIndex = position;        if (onItemClickListener != null) {            onItemClickListener.onItemClick(parent, view, position, id);        }        if (onItemSelectedListener != null) {            onItemSelectedListener.onItemSelected(parent, view, position, id);        }        baseAdapter.setSelectedIndex(position);        setTextInternal(baseAdapter.getItemInDataset(position).toString());        dismissDropDown();    }    @Override    public void onDismiss() {        if (!isArrowHidden) {            animateArrow(false);        }    }}